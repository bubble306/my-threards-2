<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo's Threads - 最终修复版</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #1d9bf0; --bg: #f7f9f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; min-height: 100px; outline: none; }
        .footer { display: flex; justify-content: space-between; align-items: center; }
        #sendBtn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #sendBtn:disabled { opacity: 0.5; }
        .post { background: white; padding: 15px; border-radius: 15px; margin-top: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; }
        .nickname { color: var(--primary); font-weight: bold; margin-bottom: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="box">
    <input type="text" id="nickname" placeholder="昵称" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ddd; border-radius:5px;">
    <textarea id="t" placeholder="这一刻的想法..."></textarea>
    <div class="footer">
        <input type="file" id="fileInput" accept="image/*">
        <button id="sendBtn" onclick="send()">发布</button>
    </div>
</div>

<div id="list" style="width: 100%; max-width: 450px;"></div>

<script>
    // 注意！这里我已经帮你换成了你截图里的 URL
    const SUPABASE_URL = 'https://fzxucsdptrikazqvdnlv.supabase.co';
    // ！！！请在这里填入你这个项目对应的那个长长的 anon public key ！！！
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY'; 
    
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function load() {
        const { data, error } = await client.from('posts').select('*').order('id', { ascending: false });
        if (error) return;
        document.getElementById('list').innerHTML = data.map(p => `
            <div class="post">
                <div class="nickname">@${p.user_name || '匿名'}</div>
                <div style="white-space: pre-wrap;">${p.content}</div>
                ${p.image_url ? `< img src="${p.image_url}" class="post-img">` : ''}
                <div style="margin-top:10px; color:#666; font-size:12px;">❤️ ${p.likes || 0} · ${new Date(p.created_at).toLocaleString()}</div>
            </div>
        `).join('');
    }

    async function send() {
        const btn = document.getElementById('sendBtn');
        const val = document.getElementById('t').value;
        const name = document.getElementById('nickname').value || '匿名';
        const file = document.getElementById('fileInput').files[0];
        let imageUrl = null;

        if (!val && !file) return;
        btn.disabled = true;
        btn.innerText = "正在发布...";

        try {
            if (file) {
                // 解决中文名报错：强制改名为数字
                const fileExt = file.name.split('.').pop();
                const safeName = `${Date.now()}.${fileExt}`;
                
                const { error: upErr } = await client.storage.from('images').upload(safeName, file);
                if (upErr) throw upErr;

                const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(safeName);
                imageUrl = publicUrl;
            }

            const { error: insErr } = await client.from('posts').insert([
                { content: val, user_name: name, likes: 0, image_url: imageUrl }
            ]);
            if (insErr) throw insErr;

            document.getElementById('t').value = "";
            document.getElementById('fileInput').value = "";
            load();
        } catch (err) {
            alert("发布失败详情: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "发布贴子";
        }
    }

    load();
</script>
</body>
</html>


